@page
@model OluRankings.Pages.Rankings.RankingsIndexModel
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Rankings";

    string FullName(OluRankings.Models.Athlete? a)
        => a is null ? "—" : $"{a.GivenName} {a.FamilyName}".Trim();

    string HeightText(int? cm)
        => cm.HasValue ? $"{cm} cm" : "—";

    string TeamText(OluRankings.Models.Athlete? a)
        => a is null
            ? "—"
            : (!string.IsNullOrWhiteSpace(a.School) ? a.School
               : !string.IsNullOrWhiteSpace(a.Club) ? a.Club
               : "—");

    var hasRows = Model.Rows is not null && Model.Rows.Count > 0;
}

<section class="rk-wrap">
  <header class="rk-header">
    <h1>Rankings</h1>

    <form method="get" class="rk-filters" role="search" aria-label="Rankings filters">

      <label class="rk-filter">
        <span>List</span>
        <select asp-for="Publisher" asp-items="@(new SelectList(Model.Publishers))"></select>
      </label>

      <label class="rk-filter">
        <span>Sport</span>
        <select asp-for="Sport">
          <option value="basketball" selected>Basketball</option>
        </select>
      </label>

      <label class="rk-filter">
        <span>Age Group</span>
        <select asp-for="AgeGroup">
          <option>U14</option>
          <option selected>U16</option>
          <option>U18</option>
        </select>
      </label>

      <label class="rk-filter">
        <span>Period</span>
        <select asp-for="Period" asp-items="@(new SelectList(Model.Periods))">
          <option value="">Latest</option>
        </select>
      </label>

      <label class="rk-filter">
        <span>Sort</span>
        <select asp-for="Sort">
          <option value="rank">Rank</option>
          <option value="name">Name</option>
          <option value="team">School/Club</option>
          <option value="region">Region</option>
          <option value="score">Score</option>
        </select>
      </label>

      <input type="hidden" name="PageNumber" value="1" />
      <input type="hidden" name="PageSize" value="@Model.PageSize" />

      <button class="rk-apply" type="submit">Apply</button>
    </form>

    @if (Model.Ranking is not null)
    {
      <p class="rk-meta">
        <span class="badge">@(Model.Ranking.Period ?? "Latest")</span>
        <span class="muted">
          Published @Model.Ranking.PublishedAt.ToLocalTime().ToString("MMM d, yyyy")
        </span>
        <span class="muted">• @Model.TotalRows results</span>
      </p>
    }
  </header>

  @if (Model.Ranking is null)
  {
    <div class="rk-empty">
      <p>No ranking found for the selected filters.</p>
    </div>
  }
  else if (!hasRows)
  {
    <div class="rk-empty">
      <p>No entries found for this ranking yet.</p>
    </div>
  }
  else
  {
    <div class="rk-tablewrap">
      <table class="rk-table">
        <thead>
          <tr>
            <th class="col-rk">RK</th>
            <th>Athlete</th>
            <th class="hide-sm">Pos</th>
            <th class="hide-sm">School / Club</th>
            <th class="hide-md">Region</th>
            <th class="hide-md">Height</th>
            <th class="hide-md">Score</th>
            <th class="col-note">Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        @foreach (var e in (Model.Rows ?? Array.Empty<OluRankings.Models.RankingEntry>()))
        {
            var a = e.Athlete;
            <tr>
              <td class="col-rk">@e.Rank</td>

              <td>
                <div class="ath">
                  <div class="ath-main">
                    <span class="ath-name">@FullName(a)</span>
                    <span class="ath-sub">
                      @((a?.ClassYear is int cy && cy > 0) ? $"Class of {cy}" : (a?.Sport ?? ""))
                    </span>
                  </div>
                </div>
              </td>

              <td class="hide-sm">@(@a?.Position ?? "—")</td>
              <td class="hide-sm">@TeamText(a)</td>
              <td class="hide-md">@(@a?.Region ?? "—")</td>
              <td class="hide-md">@HeightText(a?.HeightCm)</td>
              <td class="hide-md">@e.Score.ToString("0.0")</td>
              <td class="col-note">@(!string.IsNullOrWhiteSpace(e.Notes) ? e.Notes : "—")</td>

              <td class="col-act">
                <a class="rk-link" asp-page="/Athletes/Details" asp-route-id="@a?.Id">View</a>
              </td>
            </tr>
        }
        </tbody>
      </table>
    </div>

    <div class="rk-pager">
      <form method="get" class="rk-pager__form">
        <input type="hidden" name="Publisher" value="@Model.Publisher" />
        <input type="hidden" name="Sport" value="@Model.Sport" />
        <input type="hidden" name="AgeGroup" value="@Model.AgeGroup" />
        <input type="hidden" name="Period" value="@Model.Period" />
        <input type="hidden" name="Sort" value="@Model.Sort" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />

        <button class="rk-btn" name="PageNumber" value="@(Model.PageNumber - 1)" @(Model.PageNumber <= 1 ? "disabled" : null)>
          Prev
        </button>

        <span class="rk-pageinfo">
          Page <strong>@Model.PageNumber</strong> of <strong>@(Model.TotalPages == 0 ? 1 : Model.TotalPages)</strong>
        </span>

        <button class="rk-btn" name="PageNumber" value="@(Model.PageNumber + 1)" @(Model.PageNumber >= Model.TotalPages ? "disabled" : null)>
          Next
        </button>
      </form>
    </div>
  }
</section>

@section Scripts{
  <script>
    document.addEventListener('scroll', () => {
      const h = document.querySelector('.rk-header');
      if(!h) return;
      h.classList.toggle('elev', window.scrollY > 8);
    });
  </script>
}
