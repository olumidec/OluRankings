@page
@model OluRankings.Pages.Rankings.RankingsIndexModel
@{
    ViewData["Title"] = "Rankings";

    string FullName(OluRankings.Models.Athlete? a)
        => a is null ? "—" : $"{a.GivenName} {a.FamilyName}".Trim();

    string HeightText(int? cm)
        => cm.HasValue ? $"{cm} cm" : "—";

    string TeamText(OluRankings.Models.Athlete? a)
        => a is null
            ? "—"
            : (!string.IsNullOrWhiteSpace(a.School) ? a.School
               : !string.IsNullOrWhiteSpace(a.Club) ? a.Club
               : "—");
}

<section class="rk-wrap">
  <header class="rk-header">
    <h1>Rankings</h1>

    <form method="get" class="rk-filters" role="search" aria-label="Rankings filters">
      <label class="rk-filter">
        <span>List</span>
        <select name="Publisher" asp-for="Publisher" asp-items="@(new SelectList(Model.Publishers))"></select>
      </label>

      <label class="rk-filter">
        <span>Sport</span>
        <select name="Sport" asp-for="Sport">
          <option value="basketball" selected>Basketball</option>
        </select>
      </label>

      <label class="rk-filter">
        <span>Age Group</span>
        <select name="AgeGroup" asp-for="AgeGroup">
          <option>U14</option>
          <option selected>U16</option>
          <option>U18</option>
        </select>
      </label>

      <label class="rk-filter">
        <span>Period</span>
        <select name="Period" asp-for="Period" asp-items="@(new SelectList(Model.Periods))">
          <option value="">Latest</option>
        </select>
      </label>

      <button class="rk-apply" type="submit">Apply</button>
    </form>

    @if (Model.Ranking is not null)
    {
      <p class="rk-meta">
        <span class="badge">@(Model.Ranking.Period ?? "Latest")</span>
        <span class="muted">
          Published @Model.Ranking.PublishedAt.ToLocalTime().ToString("MMM d, yyyy")
        </span>
      </p>
    }
  </header>

  @if (Model.Ranking is null || Model.Ranking.Entries is null || !Model.Ranking.Entries.Any())
  {
    <div class="rk-empty">
      <p>No ranking found for the selected filters.</p>
    </div>
  }
  else
  {
    <div class="rk-tablewrap">
      <table class="rk-table">
        <thead>
          <tr>
            <th class="col-rk">RK</th>
            <th>Athlete</th>
            <th class="hide-sm">Pos</th>
            <th class="hide-sm">School / Club</th>
            <th class="hide-md">Region</th>
            <th class="hide-md">Height</th>
            <th class="col-note">Notes</th>
          </tr>
        </thead>
        <tbody>
        @foreach (var e in Model.Ranking.Entries.OrderBy(x => x.Rank))
        {
            var a = e.Athlete;
            <tr>
              <td class="col-rk">@e.Rank</td>
              <td>
                <div class="ath">
                  <div class="ath-main">
                    <span class="ath-name">@FullName(a)</span>
                    <span class="ath-sub">
                      @((a?.ClassYear is int cy && cy > 0) ? $"Class of {cy}" : (a?.Sport ?? ""))
                    </span>
                  </div>
                </div>
              </td>
              <td class="hide-sm">@(@a?.Position ?? "—")</td>
              <td class="hide-sm">@TeamText(a)</td>
              <td class="hide-md">@(@a?.Region ?? "—")</td>
              <td class="hide-md">@HeightText(a?.HeightCm)</td>
              <td class="col-note">@(!string.IsNullOrWhiteSpace(e.Notes) ? e.Notes : "—")</td>
            </tr>
        }
        </tbody>
      </table>
    </div>
  }
</section>

@section Scripts{
  <script>
    document.addEventListener('scroll', () => {
      const h = document.querySelector('.rk-header');
      if(!h) return;
      h.classList.toggle('elev', window.scrollY > 8);
    });
  </script>
}
